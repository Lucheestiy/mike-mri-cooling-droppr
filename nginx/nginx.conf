worker_processes  auto;

events {
  worker_connections  4096;
  use epoll;
  multi_accept on;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 120;
  keepalive_requests 1000;

  client_max_body_size 20g;
  client_body_timeout 3600s;

  # Gzip compression
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_min_length 256;
  gzip_types
    application/json
    application/javascript
    application/xml
    application/rss+xml
    text/css
    text/plain
    text/xml
    text/javascript
    image/svg+xml;

  # File Browser doesn't consistently support HEAD on some endpoints (notably /api/public/dl and /api/preview),
  # which can break image/video preview and replay on some clients. Proxy HEAD as GET so clients still get
  # correct headers like Content-Length, without receiving a response body.
  map $request_method $proxy_method {
    default $request_method;
    HEAD GET;
  }

  # Only add override=true for POST/PUT (upload) requests, not DELETE
  map $request_method $should_add_override {
    POST    1;
    PUT     1;
    default 0;
  }

  map "$should_add_override:$args" $args_with_override {
    "~^0:" $args;
    "~^1:$" "override=true";
    "~^1:.*override=" $args;
    default "$args&override=true";
  }

  upstream filebrowser_upstream {
    # Use service name 'app' which is more reliable in docker-compose
    server app:80;
    keepalive 32;
  }

  server {
    listen 80;
    absolute_redirect off;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Docker DNS resolver
    resolver 127.0.0.11 valid=30s;

    proxy_http_version 1.1;
    proxy_method $proxy_method;
    proxy_set_header Host $host;
    proxy_set_header Connection "";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Original-Method $request_method;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
    proxy_connect_timeout 30s;
    proxy_request_buffering off;
    proxy_buffering off;

    # Close connections immediately when client disconnects or timeout
    reset_timedout_connection on;
    proxy_ignore_client_abort off;

    # Stream previews/downloads directly and avoid conditional 304 responses that can confuse some media clients.
    location ^~ /api/preview/ {
      proxy_set_header If-Modified-Since "";
      proxy_set_header If-None-Match "";
      proxy_pass http://filebrowser_upstream;
    }

    # Video/file streaming - shorter timeouts to prevent stuck connections
    location ~* ^/api/public/dl/[^/]+/.+ {
      proxy_set_header If-Modified-Since "";
      proxy_set_header If-None-Match "";
      proxy_set_header If-Range "";
      # Make media cacheable by shared caches (Cloudflare) to improve seeking/scrubbing performance.
      # Keep browser max-age at 0 to avoid clients reusing stale partial caches.
      proxy_hide_header Cache-Control;
      proxy_hide_header Pragma;
      add_header Cache-Control "public, max-age=0, s-maxage=86400" always;
      proxy_pass http://filebrowser_upstream;
      proxy_read_timeout 60s;
      proxy_send_timeout 60s;
    }

    # Raw file-share download (bypasses /api/public/dl/<hash> -> /gallery redirect).
    location ~ ^/api/public/file/([A-Za-z0-9_-]+)/?$ {
      proxy_set_header If-Modified-Since "";
      proxy_set_header If-None-Match "";
      proxy_set_header If-Range "";
      proxy_hide_header Cache-Control;
      proxy_hide_header Pragma;
      add_header Cache-Control "public, max-age=0, s-maxage=86400" always;
      proxy_pass http://filebrowser_upstream/api/public/dl/$1$is_args$args;
    }

    # Share links: redirect to the gallery UI (avoid ZIP downloads).
    location ~ ^/api/public/dl/([A-Za-z0-9_-]+)/?$ {
      return 302 /gallery/$1;
    }

    # Media server API for gallery - previews (with caching)
    # NOTE: match any non-slash share hash and let the media-server validate, so invalid hashes don't fall through
    # to FileBrowser auth (which shows as 401 to public users).
    location ~ ^/api/share/([^/]+)/preview/.+ {
      proxy_pass http://droppr-media-server:5000;
      proxy_method $request_method;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_read_timeout 30s;
      # Cache thumbnails for 1 day
      add_header Cache-Control "public, max-age=86400";
    }

    # Media server API for gallery (public share browsing).
    # Keep these paths routed to media-server, but allow FileBrowser's share-management API
    # (GET/POST/DELETE /api/share/<path>) to reach FileBrowser so the UI can show existing links.
    location ~ ^/api/share/([^/]+)/files$ {
      proxy_pass http://droppr-media-server:5000;
      proxy_method $request_method;
      proxy_read_timeout 60s;
    }

    location ~ ^/api/share/([^/]+)/file/.+ {
      proxy_pass http://droppr-media-server:5000;
      proxy_method $request_method;
      proxy_read_timeout 60s;
    }

    location ~ ^/api/share/([^/]+)/download$ {
      proxy_pass http://droppr-media-server:5000;
      proxy_method $request_method;
      proxy_read_timeout 60s;
    }

    location ~ ^/api/share/([^/]+)/proxy/.+ {
      proxy_pass http://droppr-media-server:5000;
      proxy_method $request_method;
      proxy_read_timeout 60s;
    }

    location ~ ^/api/share/([^/]+)/video-sources/.+ {
      proxy_pass http://droppr-media-server:5000;
      proxy_method $request_method;
      proxy_read_timeout 60s;
    }

    location ~ ^/api/share/([^/]+)/video-meta/.+ {
      proxy_pass http://droppr-media-server:5000;
      proxy_method $request_method;
      proxy_read_timeout 60s;
    }

    # FileBrowser share management (create/list/delete shares for a filesystem path).
    # Do not override proxy_method here so HEAD is proxied as GET for FileBrowser compatibility.
    location /api/share/ {
      proxy_pass http://filebrowser_upstream;
      proxy_read_timeout 60s;
    }

    # Optimized, transcoded proxy videos (generated by media-server; served statically by nginx for Range performance)
    location ^~ /api/proxy-cache/ {
      alias /usr/share/nginx/html/proxy-cache/;
      default_type application/octet-stream;
      types {
        video/mp4 mp4;
      }
      add_header Cache-Control "public, max-age=0, s-maxage=86400" always;
    }

    # Droppr admin API (auth required; uses FileBrowser token)
    location ^~ /api/droppr/ {
      proxy_pass http://droppr-media-server:5000;
      proxy_method $request_method;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Original-Method $request_method;
    }

    # Analytics API (auth required; uses FileBrowser token)
    location ^~ /api/analytics/ {
      proxy_pass http://droppr-media-server:5000;
      proxy_method $request_method;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Original-Method $request_method;
    }

    # Modern gallery page - main media viewer
    location ~ ^/gallery/([^/]+)/?$ {
      alias /usr/share/nginx/html/gallery.html;
      default_type text/html;
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }

    # Legacy media viewer page (backup)
    location ~ ^/media/([^/]+)/?$ {
      alias /usr/share/nginx/html/media-viewer.html;
      default_type text/html;
    }

    # Lightweight single-video player (useful for iOS/WebKit stability)
    location = /player {
      alias /usr/share/nginx/html/video-player.html;
      default_type text/html;
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }
    location = /player/ {
      alias /usr/share/nginx/html/video-player.html;
      default_type text/html;
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }

    # Test media page
    location = /test-media {
      alias /usr/share/nginx/html/test-media.html;
      default_type text/html;
    }

    # Analytics page (admin-only via FileBrowser auth in API calls)
    location = /analytics {
      alias /usr/share/nginx/html/analytics.html;
      default_type text/html;
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }
    location = /analytics/ {
      alias /usr/share/nginx/html/analytics.html;
      default_type text/html;
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }

    # Allow re-uploading the same filename (fixes 409 conflicts on retries).
    # Uploads need longer timeouts for large files
    location ^~ /api/resources/ {
      # Avoid using `$uri` in `proxy_pass` (it is decoded), which breaks deletes/ops on filenames
      # that require URL-escaping (spaces, parentheses, etc). Keep the original request URI and
      # only adjust the query string to add `override=true` for upload methods.
      set $args $args_with_override;
      proxy_pass http://filebrowser_upstream;
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;
      client_body_timeout 3600s;
    }

    # Theme Injection for main UI
    location = /droppr-theme.css {
      alias /usr/share/nginx/html/droppr-theme.css;
    }

    location = /droppr-panel.js {
      alias /usr/share/nginx/html/droppr-panel.js;
      add_header Cache-Control "no-store";
    }

    location / {
      proxy_pass http://filebrowser_upstream;
      proxy_set_header Accept-Encoding "";
      sub_filter '</head>' '<link rel="stylesheet" href="/droppr-theme.css?v=10"><script defer src="/droppr-panel.js?v=21"></script></head>';
      sub_filter_once on;
    }
  }
}
