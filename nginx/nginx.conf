worker_processes  auto;

events {
  worker_connections  1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;

  client_max_body_size 20g;
  client_body_timeout 3600s;

  # File Browser doesn't consistently support HEAD on some endpoints (notably /api/public/dl and /api/preview),
  # which can break image/video preview and replay on some clients. Proxy HEAD as GET so clients still get
  # correct headers like Content-Length, without receiving a response body.
  map $request_method $proxy_method {
    default $request_method;
    HEAD GET;
  }

  map $args $args_with_override {
    "~(^|&)override=" $args;
    "" "override=true";
    default "$args&override=true";
  }

  upstream filebrowser_upstream {
    server droppr-app:80;
    keepalive 32;
  }

  server {
    listen 80;

    proxy_http_version 1.1;
    proxy_method $proxy_method;
    proxy_set_header Host $host;
    proxy_set_header Connection "";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_request_buffering on;

    # Stream previews/downloads directly and avoid conditional 304 responses that can confuse some media clients.
    location ^~ /api/preview/ {
      proxy_buffering off;
      proxy_set_header If-Modified-Since "";
      proxy_set_header If-None-Match "";
      proxy_pass http://filebrowser_upstream;
    }

    location ~* ^/api/public/dl/[^/]+/.+ {
      proxy_buffering off;
      proxy_set_header If-Modified-Since "";
      proxy_set_header If-None-Match "";
      proxy_hide_header Content-Disposition;
      add_header Content-Disposition inline;
      proxy_pass http://filebrowser_upstream;
    }

    # Redirect share links to media gallery (NO ZIP downloads)
    location ~ ^/api/public/dl/([a-zA-Z0-9]+) {
      set $share_hash $1;
      return 302 /gallery/$share_hash;
    }

    # Media server API for gallery
    location ~ ^/api/share/([a-zA-Z0-9]+)/(files|file/.+|download) {
      proxy_pass http://droppr-media-server:5000;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Modern gallery page - main media viewer
    location ~ ^/gallery/([^/]+)/?$ {
      alias /usr/share/nginx/html/gallery.html;
      add_header Content-Type text/html;
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }

    # Legacy media viewer page (backup)
    location ~ ^/media/([^/]+)/?$ {
      alias /usr/share/nginx/html/media-viewer.html;
      add_header Content-Type text/html;
    }

    # Test media page
    location = /test-media {
      alias /usr/share/nginx/html/test-media.html;
      add_header Content-Type text/html;
    }

    # Media server API routing - disabled until FileBrowser sharing works
    # location ~ ^/api/share/([^/]+)/(files|file/) {
    #   proxy_pass http://droppr-media-server:5000;
    #   proxy_set_header Host $host;
    #   proxy_set_header X-Real-IP $remote_addr;
    #   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #   proxy_set_header X-Forwarded-Proto $scheme;
    # }

    # Allow re-uploading the same filename (fixes 409 conflicts on retries).
    location ^~ /api/resources/ {
      proxy_pass http://filebrowser_upstream$uri?$args_with_override;
    }

    # Theme Injection for main UI
    location = /droppr-theme.css {
      alias /usr/share/nginx/html/droppr-theme.css;
      add_header Content-Type text/css;
    }

    location / {
      proxy_pass http://filebrowser_upstream;
      proxy_set_header Accept-Encoding "";
      sub_filter '</head>' '<link rel="stylesheet" href="/droppr-theme.css"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"></head>';
      sub_filter_once on;
    }
  }
}
