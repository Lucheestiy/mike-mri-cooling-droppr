<!-- VERSION: 1.6.0 - Video buffer progress indicator -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Shared Media Gallery</title>
    <style>
        /* Dark Theme (default) */
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.85);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #6366f1;
            --accent-hover: #4f46e5;
            --success-color: #10b981;
            --modal-bg: rgba(0, 0, 0, 0.95);
            --input-bg: rgba(0, 0, 0, 0.2);
            --border-color: rgba(255, 255, 255, 0.1);
            --hover-bg: rgba(255, 255, 255, 0.1);
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-color: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-color: #4f46e5;
            --accent-hover: #4338ca;
            --success-color: #059669;
            --modal-bg: rgba(255, 255, 255, 0.98);
            --input-bg: rgba(0, 0, 0, 0.05);
            --border-color: rgba(0, 0, 0, 0.1);
            --hover-bg: rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image:
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Light theme body background */
        [data-theme="light"] body,
        body[data-theme="light"] {
            background-image:
                radial-gradient(at 0% 0%, hsla(220,30%,96%,1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(220,40%,92%,1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(280,30%,95%,1) 0, transparent 50%);
        }

        /* When the modal is open, hide the heavy background DOM to reduce memory/paint work on mobile. */
        body.modal-open .header,
        body.modal-open .gallery-container,
        body.modal-open #backToTop {
            display: none;
        }

        /* Header */
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 3rem 1.5rem 2rem;
            padding-top: max(3rem, env(safe-area-inset-top, 0px));
            padding-left: max(1.5rem, env(safe-area-inset-left, 0px));
            padding-right: max(1.5rem, env(safe-area-inset-right, 0px));
            position: relative;
            z-index: 10;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        /* Controls Bar */
        .controls-bar {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 2rem;
            align-items: center;
            justify-content: space-between;
        }

        .search-box {
            position: relative;
            flex-grow: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border-radius: 10px;
            color: white;
            font-family: inherit;
            transition: all 0.2s;
        }

        .search-box input:focus {
            border-color: var(--accent-color);
            background: rgba(0, 0, 0, 0.3);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            background: rgba(0,0,0,0.2);
            padding: 0.25rem;
            border-radius: 10px;
        }

        .filter-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .filter-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.4em;
            padding: 0.1em 0.4em;
            margin-left: 0.4em;
            font-size: 0.75em;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 999px;
        }

        .filter-btn.active .filter-badge {
            background: rgba(255, 255, 255, 0.3);
        }

        .sort-select {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            cursor: pointer;
        }

        .action-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
        }

        .action-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .action-btn.danger {
            background: #dc2626;
        }

        .action-btn.danger:hover {
            background: #b91c1c;
        }

        /* Gallery Grid */
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem 3rem;
        }

        .media-grid {
            column-count: 4;
            column-gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .media-grid { column-count: 3; }
        }
        @media (max-width: 900px) {
            .media-grid { column-count: 2; }
            .controls-bar { flex-direction: column; align-items: stretch; }
            .header h1 { font-size: 2rem; }
        }
        @media (max-width: 600px) {
            .media-grid { column-count: 1; }
        }

        .media-card {
            break-inside: avoid;
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            content-visibility: auto;
            contain-intrinsic-size: 320px;
        }

        .media-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .media-preview-container {
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .media-preview {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.5s ease;
        }

        .media-card:hover .media-preview {
            transform: scale(1.03);
        }

        .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        .media-info {
            padding: 1rem;
        }

        .media-title {
            min-width: 0;
        }

        .media-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            word-break: break-word;
            overflow-wrap: break-word;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .video-details {
            display: none;
            margin-top: 0.35rem;
            font-size: 0.75rem;
            line-height: 1.25;
            color: var(--text-secondary);
            word-break: break-word;
        }

        body.show-details .video-details {
            display: block;
        }

        .video-details .line {
            display: block;
        }

        .media-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .card-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .card-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 0.5rem;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            text-decoration: none;
        }

        .card-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .card-btn.primary {
            background: var(--accent-color);
        }
        .card-btn.primary:hover {
            background: var(--accent-hover);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: var(--modal-bg);
            opacity: 0;
            transition: opacity 0.3s ease;
            overscroll-behavior: contain;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content-wrapper {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-media {
            max-width: 90%;
            max-height: 85vh;
            border-radius: 8px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            object-fit: contain;
            transition: transform 0.3s ease, max-height 0.3s ease, max-width 0.3s ease;
        }

        /* Immersive Mode */
        .modal.immersive {
            background: black;
            cursor: none;
        }

        .modal.immersive.active-user {
            cursor: default;
        }

        .modal.immersive .modal-media {
            max-width: 100vw;
            max-height: 100vh;
            border-radius: 0;
        }

        .modal-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            padding-top: max(1.5rem, env(safe-area-inset-top, 0px));
            padding-left: max(1.5rem, env(safe-area-inset-left, 0px));
            padding-right: max(1.5rem, env(safe-area-inset-right, 0px));
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 10;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .modal-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2rem 1.5rem;
            padding-bottom: max(2rem, env(safe-area-inset-bottom, 0px));
            padding-left: max(1.5rem, env(safe-area-inset-left, 0px));
            padding-right: max(1.5rem, env(safe-area-inset-right, 0px));
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            text-align: center;
            z-index: 10;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .modal.immersive:not(.active-user) .modal-header {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        .modal.immersive:not(.active-user) .modal-footer {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .modal.immersive:not(.active-user) .nav-btn {
            opacity: 0;
            pointer-events: none;
        }

        .modal-controls {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .icon-btn.danger {
            background: rgba(220, 38, 38, 0.8);
            border-color: rgba(220, 38, 38, 0.9);
        }

        .icon-btn.danger:hover {
            background: rgba(185, 28, 28, 1);
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            padding: 1rem;
            cursor: pointer;
            z-index: 5;
            transition: opacity 0.5s ease;
            border-radius: 50%;
            margin: 0 1rem;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-prev { left: 0; }
        .nav-next { right: 0; }

        .file-placeholder {
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 4rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Video Overlay - Fullscreen clickable overlay for stuck videos */
        .video-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            cursor: pointer;
        }

        .video-overlay.show {
            display: flex;
        }

        .video-overlay-content {
            text-align: center;
            padding: 2rem;
        }

        .video-overlay-content .spinner {
            width: 60px;
            height: 60px;
        }

        .video-overlay-content p {
            margin-top: 1.5rem;
            font-size: 1.3rem;
            color: white;
        }

        .video-overlay-content .hint {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Skeleton Loading */
        .skeleton-grid {
            column-count: 4;
            column-gap: 1.5rem;
        }
        @media (max-width: 1200px) { .skeleton-grid { column-count: 3; } }
        @media (max-width: 900px) { .skeleton-grid { column-count: 2; } }
        @media (max-width: 600px) { .skeleton-grid { column-count: 1; } }

        .skeleton-card {
            break-inside: avoid;
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .skeleton-preview {
            height: 200px;
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .skeleton-info {
            padding: 1rem;
        }

        .skeleton-title {
            height: 1.2rem;
            width: 70%;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-bottom: 0.75rem;
            animation: shimmer 1.5s infinite;
        }

        .skeleton-meta {
            height: 0.9rem;
            width: 50%;
            background: rgba(255,255,255,0.07);
            border-radius: 4px;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Error States */
        .error-state {
            text-align: center;
            padding: 4rem 1rem;
            color: var(--text-secondary);
        }

        .error-state .error-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .error-state h3 {
            color: #ef4444;
            margin-bottom: 0.5rem;
        }

        .error-state .retry-btn {
            margin-top: 1.5rem;
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .error-state .retry-btn:hover {
            background: var(--accent-hover);
        }

        /* Help Overlay */
        .help-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .help-overlay.show {
            display: flex;
            opacity: 1;
        }

        .help-content {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .help-content h2 {
            margin: 0 0 1.5rem;
            font-size: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-section {
            margin-bottom: 1.5rem;
        }

        .help-section h3 {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .shortcut-key {
            display: inline-flex;
            gap: 0.25rem;
        }

        .shortcut-key kbd {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-family: inherit;
            font-size: 0.85rem;
        }

        /* Offline Banner */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            padding-top: max(0.75rem, env(safe-area-inset-top, 0px));
            text-align: center;
            font-weight: 600;
            z-index: 4000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .offline-banner.show {
            transform: translateY(0);
        }

        /* List View Layout */
        .media-grid.list-view {
            column-count: 1 !important;
        }

        .media-grid.list-view .media-card {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .media-grid.list-view .media-preview-container {
            width: 120px;
            min-width: 120px;
            height: 80px;
            border-radius: 12px 0 0 12px;
        }

        .media-grid.list-view .media-preview {
            height: 80px;
        }

        .media-grid.list-view .media-info {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
        }

        .media-grid.list-view .media-title {
            flex: 1;
        }

        .media-grid.list-view .media-meta {
            margin: 0 1rem;
        }

        .media-grid.list-view .card-actions {
            margin: 0;
        }

        /* Layout Toggle Button */
        .layout-toggle {
            display: flex;
            gap: 0.25rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 0.25rem;
        }

        .layout-toggle button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.4rem 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .layout-toggle button.active {
            background: var(--accent-color);
            color: white;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-icon {
            color: var(--success-color);
            font-size: 1.2rem;
        }

        .icon { width: 1em; height: 1em; fill: currentColor; }

        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
            color: var(--text-secondary);
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            background: var(--accent-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border: none;
            font-size: 1.5rem;
        }

        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            background: var(--accent-hover);
            transform: translateY(-5px);
        }

        /* Media Card Improvements */
        .media-tag {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: white;
            z-index: 2;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .media-preview-container::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent 60%, rgba(0,0,0,0.4));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .media-card:hover .media-preview-container::after {
            opacity: 1;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }

        .theme-toggle:hover {
            background: var(--hover-bg);
            transform: scale(1.05);
        }

        /* Light Theme Specific Overrides */
        [data-theme="light"] .controls-bar {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        [data-theme="light"] .search-box input {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="light"] .filter-group {
            background: var(--input-bg);
        }

        [data-theme="light"] .filter-btn {
            color: var(--text-secondary);
        }

        [data-theme="light"] .sort-select {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="light"] .action-btn.secondary {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="light"] .action-btn.secondary:hover {
            background: var(--hover-bg);
        }

        [data-theme="light"] .media-card {
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .card-btn {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        [data-theme="light"] .card-btn:hover {
            background: var(--hover-bg);
        }

        [data-theme="light"] .modal {
            background: var(--modal-bg);
        }

        [data-theme="light"] .modal-header {
            background: linear-gradient(to bottom, rgba(255,255,255,0.95), transparent);
        }

        [data-theme="light"] .modal-footer {
            background: linear-gradient(to top, rgba(255,255,255,0.95), transparent);
        }

        [data-theme="light"] .icon-btn {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="light"] .icon-btn:hover {
            background: rgba(0, 0, 0, 0.15);
        }

        [data-theme="light"] .nav-btn {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        [data-theme="light"] .nav-btn:hover {
            background: rgba(0, 0, 0, 0.15);
        }

        [data-theme="light"] .toast {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        [data-theme="light"] .help-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        [data-theme="light"] .skeleton-preview {
            background: linear-gradient(90deg, rgba(0,0,0,0.05) 25%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.05) 75%);
            background-size: 200% 100%;
        }

        [data-theme="light"] .skeleton-title,
        [data-theme="light"] .skeleton-meta {
            background: rgba(0,0,0,0.08);
        }

        [data-theme="light"] .header h1 {
            background: linear-gradient(to right, #1e293b, #475569);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        [data-theme="light"] .layout-toggle {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
        }

        [data-theme="light"] .layout-toggle button {
            color: var(--text-secondary);
        }

        [data-theme="light"] .play-icon {
            background: rgba(255, 255, 255, 0.8);
            border-color: var(--text-primary);
        }

        [data-theme="light"] .file-placeholder {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .shortcut-key kbd {
            background: rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <!-- Offline Banner -->
    <div id="offlineBanner" class="offline-banner">
        <span>üì°</span>
        <span>You're offline. Some features may be unavailable.</span>
    </div>

    <!-- Video Stuck Overlay - Fullscreen clickable -->
    <div id="videoOverlay" class="video-overlay">
        <div class="video-overlay-content">
            <div class="spinner"></div>
            <p id="overlayMessage">Video is loading...</p>
            <p class="hint">Tap anywhere to reload video</p>
        </div>
    </div>

    <div class="header">
        <h1>Shared Media Gallery</h1>
        <p>Viewing files shared via Droppr</p>

        <div class="controls-bar">
            <div class="search-box">
                <span class="search-icon" aria-hidden="true">üîç</span>
                <input type="text" id="searchInput" placeholder="Search files..." aria-label="Search files">
            </div>

            <div class="filter-group" role="group" aria-label="Filter by media type">
                <button class="filter-btn active" data-filter="all" aria-pressed="true">All <span class="filter-badge" id="countAll">0</span></button>
                <button class="filter-btn" data-filter="image" aria-pressed="false">Images <span class="filter-badge" id="countImages">0</span></button>
                <button class="filter-btn" data-filter="video" aria-pressed="false">Videos <span class="filter-badge" id="countVideos">0</span></button>
            </div>

            <select class="sort-select" id="sortSelect" aria-label="Sort files">
                <option value="type_asc">Type (Images first)</option>
                <option value="type_desc">Type (Videos first)</option>
                <option value="name_asc">Name (A-Z)</option>
                <option value="name_desc">Name (Z-A)</option>
                <option value="size_desc">Size (Largest)</option>
                <option value="size_asc">Size (Smallest)</option>
            </select>

            <div class="layout-toggle" id="layoutToggle" role="group" aria-label="Layout options">
                <button id="gridViewBtn" class="active" title="Grid view" aria-label="Grid view">‚ñ¶</button>
                <button id="listViewBtn" title="List view" aria-label="List view">‚ò∞</button>
            </div>

            <button class="theme-toggle" id="themeToggle" title="Toggle dark/light theme" aria-label="Toggle theme">üåô</button>

            <button class="action-btn secondary" id="detailsBtn" title="Toggle video details">‚Ñπ Details</button>
            <button class="action-btn secondary" id="copyLinkBtn">üîó Share</button>
            <button class="action-btn secondary" id="streamBtn" title="Open Stream Gallery (optimized video player)">‚ñ∂ Stream</button>
            <button class="action-btn secondary" id="refreshBtn" title="Refresh. Shift+click = hard reload">üîÑ Refresh</button>
            <a href="#" id="downloadAllBtn" class="action-btn">‚¨áÔ∏è Download All</a>
        </div>
    </div>

    <div class="gallery-container">
        <div id="loading" class="loading">
            <div class="skeleton-grid">
                <div class="skeleton-card"><div class="skeleton-preview"></div><div class="skeleton-info"><div class="skeleton-title"></div><div class="skeleton-meta"></div></div></div>
                <div class="skeleton-card"><div class="skeleton-preview" style="height:280px"></div><div class="skeleton-info"><div class="skeleton-title"></div><div class="skeleton-meta"></div></div></div>
                <div class="skeleton-card"><div class="skeleton-preview" style="height:160px"></div><div class="skeleton-info"><div class="skeleton-title"></div><div class="skeleton-meta"></div></div></div>
                <div class="skeleton-card"><div class="skeleton-preview" style="height:220px"></div><div class="skeleton-info"><div class="skeleton-title"></div><div class="skeleton-meta"></div></div></div>
            </div>
        </div>

        <div id="errorState" class="error-state" style="display: none;">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3 id="errorTitle">Failed to load gallery</h3>
            <p id="errorMessage">Please check your connection and try again.</p>
            <button class="retry-btn" onclick="location.reload()">Try Again</button>
        </div>

        <div id="galleryGrid" class="media-grid"></div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <h3 id="emptyTitle">No files found</h3>
            <p id="emptyMessage">Try adjusting your search or filters</p>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-label="Media viewer">
        <div class="modal-header">
            <div class="modal-controls">
                <button class="icon-btn" id="zoomBtn" title="Zoom">üîç</button>
                <button class="icon-btn" id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
                <button class="icon-btn" id="slideshowBtn" title="Slideshow">‚ñ∂</button>
                <button class="icon-btn" id="speedBtn" title="Playback speed" style="display:none;">1x</button>
                <button class="icon-btn danger" id="resetVideoBtn" title="Reset video (if stuck)" style="display:none;">‚ü≥</button>
                <a href="#" class="icon-btn" id="downloadBtn" download title="Download">‚¨á</a>
                <a href="#" class="icon-btn" id="viewOriginalBtn" target="_blank" title="View Original">‚Üó</a>
                <button class="icon-btn" id="helpBtn" title="Keyboard shortcuts (?)">?</button>
            </div>
            <button class="icon-btn" id="closeBtn" title="Close">√ó</button>
        </div>

        <button class="nav-btn nav-prev" id="prevBtn" aria-label="Previous">‚ùÆ</button>
        <button class="nav-btn nav-next" id="nextBtn" aria-label="Next">‚ùØ</button>

        <div class="modal-content-wrapper" id="modalContent"></div>

        <div class="modal-footer">
            <h3 id="modalTitle">Filename</h3>
            <p id="modalMeta">Meta info</p>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <span class="toast-icon">‚úì</span>
        <span id="toastMessage">Action successful</span>
    </div>

    <button id="backToTop" class="back-to-top" title="Back to Top">‚Üë</button>

    <!-- Help Overlay -->
    <div id="helpOverlay" class="help-overlay" role="dialog" aria-modal="true">
        <div class="help-content">
            <h2>Keyboard Shortcuts <button class="icon-btn" id="closeHelpBtn">√ó</button></h2>
            <div class="help-section">
                <h3>Navigation</h3>
                <div class="shortcut-row"><span>Previous/Next</span><span class="shortcut-key"><kbd>‚Üê</kbd> <kbd>‚Üí</kbd></span></div>
                <div class="shortcut-row"><span>Close viewer</span><span class="shortcut-key"><kbd>Esc</kbd></span></div>
            </div>
            <div class="help-section">
                <h3>Video</h3>
                <div class="shortcut-row"><span>Reset stuck video</span><span class="shortcut-key"><kbd>R</kbd></span></div>
                <div class="shortcut-row"><span>Kill all connections</span><span class="shortcut-key"><kbd>K</kbd></span></div>
            </div>
            <div class="help-section">
                <h3>Other</h3>
                <div class="shortcut-row"><span>Toggle slideshow</span><span class="shortcut-key"><kbd>Space</kbd></span></div>
                <div class="shortcut-row"><span>Show this help</span><span class="shortcut-key"><kbd>?</kbd></span></div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // ============ CONFIGURATION ============
        const CONFIG = {
            STUCK_TIMEOUT: 6000,      // Show "stuck" message after 6 seconds
            SEEK_TIMEOUT: 8000,       // Show "seek stuck" after 8 seconds
            MAX_PRELOAD_CACHE: 15,    // Max cached images
            SLIDESHOW_INTERVAL: 4000  // 4 seconds per slide
        };

        // ============ BROWSER DETECTION ============
        const UA = navigator.userAgent || '';
        const IS_IOS = /iPad|iPhone|iPod/.test(UA) || (navigator.platform === 'MacIntel' && (navigator.maxTouchPoints || 0) > 1);

        // ============ STATE ============
	        const state = {
	            files: [],
	            filteredFiles: [],
	            currentIndex: 0,
            shareHash: null,
            filter: 'all',
            sort: 'type_asc',
            layout: 'grid',
            showDetails: true,
            search: '',
            isSlideshow: false,
            slideshowInterval: null,
            isZoomed: false,
            immersiveTimer: null,
            touchStartX: null,
            isOffline: !navigator.onLine,
	            videoTimers: {
	                stuck: null,
	                wait: null,
	                seek: null,
	                stall: null
	            },
	            videoStatusInterval: null,
	            scrollLockY: 0,
	            videoMetaCache: {},
	            videoMetaInFlight: {}
	        };

        // ============ DOM ELEMENTS ============
        const els = {};

        function initElements() {
            els.grid = document.getElementById('galleryGrid');
            els.loading = document.getElementById('loading');
            els.empty = document.getElementById('emptyState');
            els.emptyTitle = document.getElementById('emptyTitle');
            els.emptyMessage = document.getElementById('emptyMessage');
            els.error = document.getElementById('errorState');
            els.errorTitle = document.getElementById('errorTitle');
            els.errorMessage = document.getElementById('errorMessage');
            els.search = document.getElementById('searchInput');
            els.sort = document.getElementById('sortSelect');
            els.filters = document.querySelectorAll('.filter-btn');
            els.modal = document.getElementById('modal');
            els.modalContent = document.getElementById('modalContent');
            els.modalTitle = document.getElementById('modalTitle');
            els.modalMeta = document.getElementById('modalMeta');
            els.downloadAll = document.getElementById('downloadAllBtn');
            els.copyLink = document.getElementById('copyLinkBtn');
            els.streamBtn = document.getElementById('streamBtn');
            els.refresh = document.getElementById('refreshBtn');
            els.details = document.getElementById('detailsBtn');
            els.backToTop = document.getElementById('backToTop');
            els.viewOriginal = document.getElementById('viewOriginalBtn');
            els.download = document.getElementById('downloadBtn');
            els.videoOverlay = document.getElementById('videoOverlay');
            els.overlayMessage = document.getElementById('overlayMessage');
            els.speedBtn = document.getElementById('speedBtn');
            els.resetVideoBtn = document.getElementById('resetVideoBtn');
            els.helpOverlay = document.getElementById('helpOverlay');
            els.offlineBanner = document.getElementById('offlineBanner');
            els.themeToggle = document.getElementById('themeToggle');
        }

        // ============ PREFERENCES ============
        const PREFS_KEY = 'droppr_gallery_prefs';

        function loadPrefs() {
            try {
                return JSON.parse(localStorage.getItem(PREFS_KEY) || '{}');
            } catch { return {}; }
        }

        function savePrefs(prefs) {
            try {
                localStorage.setItem(PREFS_KEY, JSON.stringify({ ...loadPrefs(), ...prefs }));
            } catch {}
        }

        // ============ THEME FUNCTIONS ============
        function getTheme() {
            const prefs = loadPrefs();
            return prefs.theme || 'dark';
        }

        function setTheme(theme) {
            const isDark = theme === 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            if (els.themeToggle) {
                els.themeToggle.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
                els.themeToggle.title = isDark ? 'Switch to light theme' : 'Switch to dark theme';
            }
            savePrefs({ theme });
        }

        function toggleTheme() {
            const current = getTheme();
            setTheme(current === 'dark' ? 'light' : 'dark');
        }

        function initTheme() {
            const theme = getTheme();
            setTheme(theme);
            if (els.themeToggle) {
                els.themeToggle.addEventListener('click', toggleTheme);
            }
        }

        // ============ UTILITY FUNCTIONS ============
        function encodePath(p) {
            return String(p || '').split('/').map(s => encodeURIComponent(s)).join('/');
        }

        function formatSize(b) {
            if (!b) return '0 B';
            const k = 1024, s = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(b) / Math.log(k));
            return (b / Math.pow(k, i)).toFixed(1) + ' ' + s[i];
        }

        function formatDuration(seconds) {
            const s = Number(seconds);
            if (!Number.isFinite(s) || s <= 0) return '';
            const total = Math.floor(s);
            const h = Math.floor(total / 3600);
            const m = Math.floor((total % 3600) / 60);
            const sec = total % 60;
            if (h > 0) return `${h}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            return `${m}:${String(sec).padStart(2, '0')}`;
        }

        function formatUnixSeconds(tsSeconds) {
            if (tsSeconds == null) return '';
            const n = parseInt(String(tsSeconds), 10);
            if (!Number.isFinite(n) || n <= 0) return '';
            try {
                return new Date(n * 1000).toLocaleString();
            } catch {
                return '';
            }
        }

        function actionLabel(action) {
            const a = String(action || '').toLowerCase();
            if (a === 'transcode_hevc_to_h264') return 'Transcoded HEVC ‚Üí H.264';
            if (a === 'fix_video_errors_extra_streams') return 'Re-encoded (removed extra streams)';
            if (a === 'fix_video_errors_timestamp') return 'Re-encoded (fixed timestamps)';
            if (a === 'faststart') return 'Faststart (moov moved)';
            if (a === 'already_faststart') return 'Already faststart';
            if (a === 'none') return 'No changes';
            return action ? String(action) : '';
        }

        function formatVideoSummary(meta, sizeOverride) {
            if (!meta || typeof meta !== 'object') {
                const s = Number(sizeOverride);
                return Number.isFinite(s) && s > 0 ? formatSize(s) : '‚Äî';
            }

            const v = (meta.video && typeof meta.video === 'object') ? meta.video : {};
            const a = (meta.audio && typeof meta.audio === 'object') ? meta.audio : {};

            let size = null;
            if (Number.isFinite(Number(sizeOverride)) && Number(sizeOverride) > 0) size = Number(sizeOverride);
            else if (Number.isFinite(Number(meta.size)) && Number(meta.size) > 0) size = Number(meta.size);

            const w = parseInt(String(v.display_width || v.width || ''), 10);
            const h = parseInt(String(v.display_height || v.height || ''), 10);
            const res = (!isNaN(w) && !isNaN(h) && w > 0 && h > 0) ? `${w}√ó${h}` : '';

            const vCodec = v.codec ? String(v.codec).toUpperCase() : '';
            const aCodec = a.codec ? String(a.codec).toUpperCase() : '';
            const codecs = vCodec ? (aCodec ? `${vCodec}/${aCodec}` : vCodec) : (aCodec || '');

            const dur = formatDuration(meta.duration);
            const fpsNum = Number(v.fps);
            const fps = Number.isFinite(fpsNum) && fpsNum > 0 ? `${Math.round(fpsNum * 100) / 100}fps` : '';

            return [
                size ? formatSize(size) : '',
                res,
                codecs,
                dur,
                fps,
            ].filter(Boolean).join(' ‚Ä¢ ') || '‚Äî';
        }

        function updateDetailsButton() {
            if (!els.details) return;
            els.details.textContent = state.showDetails ? '‚Ñπ Details: On' : '‚Ñπ Details: Off';
        }

        function setDetailsEnabled(enabled, opts = {}) {
            const on = !!enabled;
            state.showDetails = on;
            document.body.classList.toggle('show-details', on);
            updateDetailsButton();
            if (!opts.skipSave) savePrefs({ show_details: on });
            if (on) hydrateVideoDetails();
        }

        async function fetchVideoMeta(path) {
            const url = `/api/share/${state.shareHash}/video-meta/${encodePath(path)}?t=${Date.now()}`;
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) return null;
            return await res.json();
        }

        function renderVideoDetails(el, data) {
            if (!el) return;
            if (!data || typeof data !== 'object') {
                el.innerHTML = '<span class="line">Details unavailable</span>';
                el.dataset.loaded = '1';
                return;
            }

            const lines = [];

            if (data.recorded) {
                const uploaded = formatUnixSeconds(data.uploaded_at);
                if (uploaded) lines.push(`Uploaded: ${uploaded}`);

                const original = formatVideoSummary(data.original, data.original_size);
                const processed = formatVideoSummary(data.processed, data.processed_size);
                lines.push(`Original: ${original}`);

                const action = actionLabel(data.action);
                lines.push(`After: ${processed}${action ? ` ‚Ä¢ ${action}` : ''}`);
            } else {
                const cur = data.current && data.current.size ? formatSize(data.current.size) : '';
                lines.push(cur ? `Size: ${cur}` : 'No video metadata recorded yet');
            }

            el.innerHTML = lines.map(l => `<span class="line">${l}</span>`).join('');
            el.dataset.loaded = '1';
        }

        async function hydrateVideoDetails() {
            if (!state.showDetails) return;

            const nodes = Array.from(document.querySelectorAll('.video-details[data-video-meta="1"]'));
            const pending = nodes.filter(el => el && !el.dataset.loaded && el.dataset.path);
            if (!pending.length) return;

            let idx = 0;
            const maxWorkers = Math.min(4, pending.length);

            async function worker() {
                while (idx < pending.length) {
                    const el = pending[idx++];
                    const enc = String(el.dataset.path || '');
                    let path = enc;
                    try { path = decodeURIComponent(enc); } catch {}

                    const key = `${state.shareHash}:${path}`;
                    if (state.videoMetaCache[key]) {
                        renderVideoDetails(el, state.videoMetaCache[key]);
                        continue;
                    }

                    if (state.videoMetaInFlight[key]) continue;
                    state.videoMetaInFlight[key] = true;
                    try {
                        const data = await fetchVideoMeta(path);
                        if (data) state.videoMetaCache[key] = data;
                        renderVideoDetails(el, data);
                    } catch (e) {
                        renderVideoDetails(el, null);
                    } finally {
                        delete state.videoMetaInFlight[key];
                    }
                }
            }

            const workers = [];
            for (let i = 0; i < maxWorkers; i++) workers.push(worker());
            await Promise.all(workers);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Robust clipboard copy with iOS Safari fallback
        async function copyToClipboard(text) {
            // Try modern Clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch (e) {
                    console.warn('Clipboard API failed, trying fallback:', e);
                }
            }

            // Fallback for iOS Safari and older browsers
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.setAttribute('readonly', '');
            textarea.style.cssText = 'position:fixed;top:0;left:0;width:2em;height:2em;padding:0;border:none;outline:none;box-shadow:none;background:transparent;font-size:16px;';
            document.body.appendChild(textarea);

            // iOS Safari specific handling
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                const range = document.createRange();
                range.selectNodeContents(textarea);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                textarea.setSelectionRange(0, text.length);
            } else {
                textarea.focus();
                textarea.select();
            }

            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (e) {
                console.warn('execCommand copy failed:', e);
            }

            document.body.removeChild(textarea);
            return success;
        }

        // Prevent the underlying page from scrolling while the modal is open.
        // This avoids expensive repaint work (and perceived "freezing") on some devices,
        // especially while a video is playing.
        function lockPageScroll() {
            if (document.body.classList.contains('modal-open')) return;
            state.scrollLockY = window.scrollY || 0;
            document.body.classList.add('modal-open');
            document.body.style.position = 'fixed';
            document.body.style.top = `-${state.scrollLockY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
        }

        function unlockPageScroll() {
            if (!document.body.classList.contains('modal-open')) return;
            document.body.classList.remove('modal-open');
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
            const y = state.scrollLockY || 0;
            state.scrollLockY = 0;
            window.scrollTo(0, y);
        }

        // ============ VIDEO MANAGEMENT ============
        // Central video cleanup - clears everything
        function clearAllVideoTimers() {
            if (!state.videoTimers) return;
            for (const key of Object.keys(state.videoTimers)) {
                const t = state.videoTimers[key];
                if (t) clearTimeout(t);
                state.videoTimers[key] = null;
            }
        }

	        function destroyVideo() {
	            clearAllVideoTimers();
	            if (state.videoStatusInterval) {
	                clearInterval(state.videoStatusInterval);
	                state.videoStatusInterval = null;
	            }
	            hideVideoOverlay();

            const video = els.modalContent.querySelector('video');
            if (video) {
                // Remove all event listeners by cloning
                const events = ['loadstart', 'waiting', 'canplaythrough', 'playing',
                               'error', 'stalled', 'seeking', 'seeked', 'abort', 'ended'];
                events.forEach(e => video['on' + e] = null);

                try { video.pause(); } catch(e) {}
                video.src = '';
                video.load();
                video.remove();
            }
        }

        function killAllConnections() {
            destroyVideo();
            showToast('Connections reset');
        }

        function showVideoOverlay(message) {
            els.overlayMessage.textContent = message;
            els.videoOverlay.classList.add('show');
        }

        function hideVideoOverlay() {
            els.videoOverlay.classList.remove('show');
        }

        function reloadCurrentVideo() {
            destroyVideo();
            setTimeout(() => {
                updateModalContent();
                showToast('Video reloaded');
            }, 200);
        }

        // Overlay click handler - set up in setupEventHandlers after DOM ready

        // ============ MODAL CONTENT ============
        const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
        let currentSpeedIndex = 2;

	        function updateModalContent() {
	            const file = state.filteredFiles[state.currentIndex];
            if (!file) {
                closeModal();
                return;
            }

            destroyVideo();
            els.modalContent.innerHTML = '';

            const path = file.path || file.name;
            const inlineUrl = file.inline_url || `/api/public/dl/${state.shareHash}/${encodePath(path)}?inline=true`;
            const previewUrl = `/api/share/${state.shareHash}/preview/${encodePath(path)}?v=${file.size || 0}`;
            const downloadUrl = file.download_url || `/api/share/${state.shareHash}/file/${encodePath(path)}?download=1`;

            els.modalTitle.textContent = file.name;
            els.modalMeta.textContent = `${state.currentIndex + 1} of ${state.filteredFiles.length} ‚Ä¢ ${formatSize(file.size)}`;
            els.viewOriginal.href = inlineUrl;
            els.download.href = downloadUrl;
            els.download.download = file.name;

	            if (file.type === 'video') {
	                els.speedBtn.style.display = 'inline-flex';
	                els.resetVideoBtn.style.display = 'inline-flex';
	                createVideoPlayer(inlineUrl, previewUrl, file);
	            } else {
                els.speedBtn.style.display = 'none';
                els.resetVideoBtn.style.display = 'none';

                if (file.type === 'image') {
                    els.modalContent.innerHTML = `<img class="modal-media" src="${inlineUrl}" alt="${file.name}">`;
                } else {
                    els.modalContent.innerHTML = `
                        <div style="text-align:center;padding:2rem;">
                            <div style="font-size:4rem;margin-bottom:1rem;">${getFileIcon(file.extension)}</div>
                            <p>Preview not available</p>
                            <a href="${downloadUrl}" class="action-btn" style="margin-top:1rem;display:inline-flex;">‚¨áÔ∏è Download</a>
                        </div>`;
                }
            }
        }

	        function createVideoPlayer(videoUrl, posterUrl, file) {
	            const container = document.createElement('div');
	            container.style.cssText = 'position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;';

            const video = document.createElement('video');
            video.className = 'modal-media';
            video.controls = true;
            video.autoplay = true;
            video.playsInline = true;
            video.preload = 'metadata';
            video.poster = posterUrl;
            video.innerHTML = `<source src="${videoUrl}">`;

	            container.appendChild(video);
	            els.modalContent.appendChild(container);

	            // Update footer with buffered/download progress for the current video.
	            if (state.videoStatusInterval) {
	                clearInterval(state.videoStatusInterval);
	                state.videoStatusInterval = null;
	            }

	            function updateVideoMeta() {
	                const base = `${state.currentIndex + 1} of ${state.filteredFiles.length} ‚Ä¢ ${formatSize(file?.size || 0)}`;

	                const dur = Number.isFinite(video.duration) ? video.duration : null;
	                if (!dur || dur <= 0) {
	                    els.modalMeta.textContent = base;
	                    return;
	                }

	                let bufferedTotal = 0;
	                let bufferedAhead = 0;
	                const ct = Number.isFinite(video.currentTime) ? video.currentTime : 0;
	                try {
	                    const b = video.buffered;
	                    for (let i = 0; i < b.length; i++) {
	                        const s = b.start(i);
	                        const e = b.end(i);
	                        if (!Number.isFinite(s) || !Number.isFinite(e) || e <= s) continue;
	                        bufferedTotal += (e - s);
	                        if (ct >= s && ct <= e) bufferedAhead = Math.max(bufferedAhead, e - ct);
	                    }
	                } catch (e) {}

	                const pct = Math.max(0, Math.min(1, bufferedTotal / dur));
	                const pctText = Math.round(pct * 100);

	                let extra = ` ‚Ä¢ Buffered ${pctText}%`;
	                const size = Number(file?.size || 0);
	                if (Number.isFinite(size) && size > 0) {
	                    extra += ` (‚âà${formatSize(size * pct)} / ${formatSize(size)})`;
	                }
	                if (bufferedAhead > 0) extra += ` ‚Ä¢ Ahead ${Math.round(bufferedAhead)}s`;

	                els.modalMeta.textContent = base + extra;
	            }

	            updateVideoMeta();
	            state.videoStatusInterval = setInterval(updateVideoMeta, 500);
	            video.addEventListener('progress', updateVideoMeta);
	            video.addEventListener('timeupdate', updateVideoMeta);
	            video.addEventListener('loadedmetadata', updateVideoMeta);
	            video.addEventListener('seeking', updateVideoMeta);
	            video.addEventListener('seeked', updateVideoMeta);

	            // Set playback rate
	            video.playbackRate = speeds[currentSpeedIndex];

            // Track loading state
            let isStuck = false;
            let hasPlayed = false;

            // Stuck detection timer
            if (state.videoTimers.stuck) clearTimeout(state.videoTimers.stuck);
            state.videoTimers.stuck = setTimeout(() => {
                if (!hasPlayed && !video.paused) {
                    isStuck = true;
                    showVideoOverlay('Video stuck - tap anywhere to reload');
                }
            }, CONFIG.STUCK_TIMEOUT);

            // Event handlers
            video.onplaying = () => {
                hasPlayed = true;
                isStuck = false;
                hideVideoOverlay();
                clearAllVideoTimers();
            };

            video.oncanplaythrough = () => {
                hideVideoOverlay();
            };

            video.onwaiting = () => {
                if (hasPlayed) {
                    // Only show overlay if it's been playing then buffers
                    if (state.videoTimers.wait) clearTimeout(state.videoTimers.wait);
                    state.videoTimers.wait = setTimeout(() => {
                        if (video.readyState < 3) {
                            showVideoOverlay('Buffering... tap to reload if stuck');
                        }
                    }, CONFIG.STUCK_TIMEOUT);
                }
            };

            video.onseeking = () => {
                if (state.videoTimers.seek) clearTimeout(state.videoTimers.seek);
                state.videoTimers.seek = setTimeout(() => {
                    if (video.seeking) {
                        showVideoOverlay('Seek stuck - tap anywhere to reload');
                    }
                }, CONFIG.SEEK_TIMEOUT);
            };

            video.onseeked = () => {
                hideVideoOverlay();
                if (state.videoTimers.seek) {
                    clearTimeout(state.videoTimers.seek);
                    state.videoTimers.seek = null;
                }
            };

            video.onerror = () => {
                hideVideoOverlay();
                clearAllVideoTimers();
                showToast('Video failed to load');
            };

            video.onstalled = () => {
                if (state.videoTimers.stall) clearTimeout(state.videoTimers.stall);
                state.videoTimers.stall = setTimeout(() => {
                    if (video.readyState < 3) {
                        showVideoOverlay('Video stalled - tap to reload');
                    }
                }, CONFIG.STUCK_TIMEOUT);
            };
        }

        // Speed control
        document.getElementById('speedBtn').onclick = () => {
            currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
            const speed = speeds[currentSpeedIndex];
            els.speedBtn.textContent = speed === 1 ? '1x' : speed + 'x';
            const video = els.modalContent.querySelector('video');
            if (video) video.playbackRate = speed;
            showToast(`Speed: ${speed}x`);
        };

        // Reset video button
        document.getElementById('resetVideoBtn').onclick = reloadCurrentVideo;

        // ============ MODAL FUNCTIONS ============
        function openModal(index) {
            if (index < 0 || index >= state.filteredFiles.length) return;

            state.currentIndex = index;
            state.isZoomed = false;
            document.getElementById('zoomBtn').textContent = 'üîç';
            if (state.isSlideshow) toggleSlideshow();

            lockPageScroll();
            els.modal.style.display = 'block';
            els.modal.offsetHeight; // Force reflow
            els.modal.classList.add('show');
            updateModalContent();
            resetImmersiveTimer();
            maybePreloadAdjacentImages();
        }
        window.openModal = openModal;

        // Open media with platform-aware defaults (iOS/WebKit can be more stable in a video-only page).
        function openMedia(index, evt) {
            const file = state.filteredFiles[index];
            if (!file) return;

            if (file.type === 'video') {
                const path = file.path || file.name;
                const url = `/player?share=${encodeURIComponent(state.shareHash)}&file=${encodeURIComponent(path)}`;

                // Desktop escape hatch: Shift-click opens the in-gallery modal viewer instead of /player.
                if (evt && evt.shiftKey) {
                    openModal(index);
                } else {
                    window.location.href = url;
                }
                return;
            }

            openModal(index);
        }
        window.openMedia = openMedia;

        function closeModal() {
            destroyVideo();
            if (state.isSlideshow) {
                clearInterval(state.slideshowInterval);
                state.isSlideshow = false;
            }
            clearTimeout(state.immersiveTimer);
            els.modal.classList.remove('show', 'immersive');
            setTimeout(() => {
                if (els.modal.classList.contains('show')) return;
                els.modal.style.display = 'none';
                els.modalContent.innerHTML = '';
                unlockPageScroll();
            }, 300);
        }

        function navigate(direction) {
            const newIndex = state.currentIndex + direction;
            if (newIndex >= 0 && newIndex < state.filteredFiles.length) {
                state.isZoomed = false;
                document.getElementById('zoomBtn').textContent = 'üîç';

                const nextFile = state.filteredFiles[newIndex];
                if (state.isSlideshow && nextFile?.type === 'video') {
                    toggleSlideshow();
                }

                state.currentIndex = newIndex;
                updateModalContent();
                resetImmersiveTimer();
                maybePreloadAdjacentImages();
            }
        }

        function resetImmersiveTimer() {
            els.modal.classList.add('active-user');
            clearTimeout(state.immersiveTimer);
            state.immersiveTimer = setTimeout(() => els.modal.classList.remove('active-user'), 3000);
        }

        // ============ IMAGE PRELOADING ============
        const preloadCache = new Map();

        function preloadImage(url) {
            if (preloadCache.has(url)) return;
            if (preloadCache.size >= CONFIG.MAX_PRELOAD_CACHE) {
                const firstKey = preloadCache.keys().next().value;
                preloadCache.delete(firstKey);
            }
            const img = new Image();
            img.src = url;
            preloadCache.set(url, img);
        }

        function preloadAdjacentImages() {
            [-1, 1].forEach(offset => {
                const i = state.currentIndex + offset;
                if (i >= 0 && i < state.filteredFiles.length) {
                    const file = state.filteredFiles[i];
                    if (file.type === 'image') {
                        const path = file.path || file.name;
                        const url = file.inline_url || `/api/public/dl/${state.shareHash}/${encodePath(path)}?inline=true`;
                        preloadImage(url);
                    }
                }
            });
        }

        function maybePreloadAdjacentImages() {
            const current = state.filteredFiles[state.currentIndex];
            if (current?.type !== 'image') return;
            preloadAdjacentImages();
        }

        // ============ FILE ICON ============
        function getFileIcon(ext) {
            const e = (ext || '').toLowerCase();
            const icons = {
                pdf: 'üìï', doc: 'üìÑ', docx: 'üìÑ', txt: 'üìù',
                xls: 'üìä', xlsx: 'üìä', csv: 'üìä',
                ppt: 'üìΩÔ∏è', pptx: 'üìΩÔ∏è',
                zip: 'üì¶', rar: 'üì¶', '7z': 'üì¶',
                mp3: 'üéµ', wav: 'üéµ', flac: 'üéµ',
                html: 'üåê', css: 'üé®', js: '‚öôÔ∏è', json: 'üìã',
                py: 'üêç', java: '‚òï',
            };
            return icons[e] || 'üìÑ';
        }

        // ============ GALLERY FUNCTIONS ============
        async function fetchFiles(forceRefresh = false) {
            const params = new URLSearchParams();
            if (forceRefresh) params.set('refresh', '1');
            params.set('v', Date.now());

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);

            try {
                const res = await fetch(
                    `/api/share/${state.shareHash}/files?${params}`,
                    { cache: 'no-store', signal: controller.signal }
                );
                if (!res.ok) throw new Error(`Failed: ${res.status}`);
                state.files = await res.json();
                filterAndRender();
            } finally {
                clearTimeout(timeout);
            }
        }

        function filterAndRender() {
            els.loading.style.display = 'none';
            els.error.style.display = 'none';

            // Update counts
            const searchLower = state.search.toLowerCase();
            const matching = state.files.filter(f => f.name.toLowerCase().includes(searchLower));
            document.getElementById('countAll').textContent = matching.length;
            document.getElementById('countImages').textContent = matching.filter(f => f.type === 'image').length;
            document.getElementById('countVideos').textContent = matching.filter(f => f.type === 'video').length;

            // Filter
            state.filteredFiles = state.files.filter(file => {
                const matchesType = state.filter === 'all' || file.type === state.filter;
                const matchesSearch = file.name.toLowerCase().includes(searchLower);
                return matchesType && matchesSearch;
            });

            // Sort
            state.filteredFiles.sort((a, b) => {
                const typeScore = t => t === 'image' ? 1 : (t === 'video' ? 2 : 3);
                switch (state.sort) {
                    case 'type_asc': return typeScore(a.type) - typeScore(b.type) || a.name.localeCompare(b.name);
                    case 'type_desc': return typeScore(b.type) - typeScore(a.type) || a.name.localeCompare(b.name);
                    case 'name_asc': return a.name.localeCompare(b.name);
                    case 'name_desc': return b.name.localeCompare(a.name);
                    case 'size_asc': return a.size - b.size;
                    case 'size_desc': return b.size - a.size;
                    default: return 0;
                }
            });

            renderGrid();
        }

        function renderGrid() {
            els.grid.innerHTML = '';

            if (state.filteredFiles.length === 0) {
                els.emptyTitle.textContent = state.files.length === 0 ? 'This share is empty' : 'No files found';
                els.emptyMessage.textContent = state.files.length === 0 ? 'No files have been shared yet.' : 'Try adjusting your search or filters';
                els.empty.style.display = 'block';
                return;
            }

            els.empty.style.display = 'none';

            state.filteredFiles.forEach((file, index) => {
                const card = document.createElement('div');
                card.className = 'media-card';
                card.innerHTML = createCardHTML(file, index);
                els.grid.appendChild(card);
            });

            if (state.showDetails) {
                hydrateVideoDetails().catch(() => {});
            }
        }

        function createCardHTML(file, index) {
            const path = file.path || file.name;
            const inlineUrl = file.inline_url || `/api/public/dl/${state.shareHash}/${encodePath(path)}?inline=true`;
            const downloadUrl = file.download_url || `/api/share/${state.shareHash}/file/${encodePath(path)}?download=1`;
            const previewUrl = `/api/share/${state.shareHash}/preview/${encodePath(path)}?v=${file.size || 0}`;
            const isVideo = file.type === 'video';
            const isImage = file.type === 'image';

            let preview = '';
            if (isImage) {
                // Use server-generated thumbnails for grid/list previews to keep memory usage low on mobile.
                preview = `<img class="media-preview" src="${previewUrl}" data-fallback="${inlineUrl}" loading="lazy" decoding="async" fetchpriority="low" alt="${file.name}"
                             onerror="this.onerror=null;this.src=this.dataset.fallback;">`;
            } else if (isVideo) {
                preview = `
                    <img class="media-preview" src="${previewUrl}" loading="lazy" decoding="async" fetchpriority="low" alt="${file.name}"
                         style="object-fit:cover;height:200px;width:100%;"
                         onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                    <div class="file-placeholder" style="background:#000;display:none;height:200px;align-items:center;justify-content:center;">
                        <div style="font-size:2.75rem">üéûÔ∏è</div>
                    </div>
                    <div class="play-icon">‚ñ∂</div>`;
            } else {
                preview = `<div class="file-placeholder">${getFileIcon(file.extension)} ${file.extension.toUpperCase()}</div>`;
            }

            const tag = isVideo ? 'Video' : (isImage ? 'Image' : 'File');

            return `
                <div class="media-preview-container" onclick="openMedia(${index}, event)">
                    <div class="media-tag">${tag}</div>
                    ${preview}
                </div>
                <div class="media-info">
                    <div class="media-title">
                        <div class="media-name" title="${file.name}">${file.name}</div>
                        ${isVideo ? `<div class="video-details" data-video-meta="1" data-path="${encodeURIComponent(path)}">Loading‚Ä¶</div>` : ''}
                    </div>
                    <div class="media-meta"><span>${file.extension.toUpperCase()}</span><span title="${file.size.toLocaleString()} bytes">${formatSize(file.size)}</span></div>
                    <div class="card-actions">
                        <button class="card-btn primary" onclick="openMedia(${index}, event)">${isVideo ? 'Play' : 'View'}</button>
                        <a href="${downloadUrl}" download="${file.name}" class="card-btn">‚¨á</a>
                    </div>
                </div>`;
        }

        // ============ SLIDESHOW ============
        function toggleSlideshow() {
            state.isSlideshow = !state.isSlideshow;
            document.getElementById('slideshowBtn').textContent = state.isSlideshow ? '‚è∏' : '‚ñ∂';

            if (state.isSlideshow) {
                els.modal.classList.add('immersive');
                state.slideshowInterval = setInterval(() => {
                    if (state.currentIndex < state.filteredFiles.length - 1) {
                        navigate(1);
                    } else {
                        state.currentIndex = -1;
                        navigate(1);
                    }
                }, CONFIG.SLIDESHOW_INTERVAL);
            } else {
                clearInterval(state.slideshowInterval);
                els.modal.classList.remove('immersive');
            }
        }

        // ============ EVENT HANDLERS ============
        function setupEventHandlers() {
            // Video overlay click handler
            els.videoOverlay.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                reloadCurrentVideo();
            };

            // Search
            let searchTimeout;
            els.search.oninput = e => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.search = e.target.value;
                    filterAndRender();
                }, 150);
            };

            // Sort
            els.sort.onchange = e => {
                state.sort = e.target.value;
                savePrefs({ sort: state.sort });
                filterAndRender();
            };

            // Filters
            els.filters.forEach(btn => {
                btn.onclick = () => {
                    els.filters.forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-pressed', 'false');
                    });
                    btn.classList.add('active');
                    btn.setAttribute('aria-pressed', 'true');
                    state.filter = btn.dataset.filter;
                    savePrefs({ filter: state.filter });
                    filterAndRender();
                };
            });

            // Copy link
            els.copyLink.onclick = async () => {
                const success = await copyToClipboard(window.location.href);
                showToast(success ? 'Link copied' : 'Copy failed - select and copy manually');
            };

            // Stream Gallery button
            els.streamBtn.onclick = () => {
                const streamUrl = '/stream/' + state.shareHash;
                window.open(streamUrl, '_blank');
            };

            // Refresh
            els.refresh.onclick = e => {
                if (e.shiftKey) {
                    killAllConnections();
                    location.reload();
                } else {
                    fetchFiles(true).catch(console.error);
                }
            };

            // Details toggle
            if (els.details) {
                els.details.onclick = () => setDetailsEnabled(!state.showDetails);
            }

            // Modal controls
            document.getElementById('closeBtn').onclick = closeModal;
            document.getElementById('prevBtn').onclick = () => navigate(-1);
            document.getElementById('nextBtn').onclick = () => navigate(1);
            document.getElementById('slideshowBtn').onclick = toggleSlideshow;

            // Zoom
            document.getElementById('zoomBtn').onclick = () => {
                state.isZoomed = !state.isZoomed;
                const media = els.modalContent.querySelector('.modal-media');
                if (media) {
                    media.style.transform = state.isZoomed ? 'scale(1.5)' : 'scale(1)';
                }
                document.getElementById('zoomBtn').textContent = state.isZoomed ? 'üîé' : 'üîç';
            };

            // Fullscreen
            document.getElementById('fullscreenBtn').onclick = () => {
                if (!document.fullscreenElement) {
                    els.modal.requestFullscreen?.();
                    els.modal.classList.add('immersive');
                } else {
                    document.exitFullscreen?.();
                    els.modal.classList.remove('immersive');
                }
            };

            // Layout toggle
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            gridBtn.onclick = () => {
                state.layout = 'grid';
                savePrefs({ layout: 'grid' });
                els.grid.classList.remove('list-view');
                gridBtn.classList.add('active');
                listBtn.classList.remove('active');
            };
            listBtn.onclick = () => {
                state.layout = 'list';
                savePrefs({ layout: 'list' });
                els.grid.classList.add('list-view');
                listBtn.classList.add('active');
                gridBtn.classList.remove('active');
            };

            // Back to top
            window.addEventListener('scroll', () => {
                els.backToTop.classList.toggle('show', window.scrollY > 500);
            });
            els.backToTop.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

            // Help
            document.getElementById('helpBtn').onclick = () => els.helpOverlay.classList.add('show');
            document.getElementById('closeHelpBtn').onclick = () => els.helpOverlay.classList.remove('show');
            els.helpOverlay.onclick = e => { if (e.target === els.helpOverlay) els.helpOverlay.classList.remove('show'); };

            // Keyboard shortcuts
            document.addEventListener('keydown', e => {
                // Help
                if (e.key === '?' || (e.key === '/' && e.shiftKey)) {
                    e.preventDefault();
                    els.helpOverlay.classList.toggle('show');
                    return;
                }

                if (e.key === 'Escape') {
                    if (els.helpOverlay.classList.contains('show')) {
                        els.helpOverlay.classList.remove('show');
                    } else if (els.modal.style.display === 'block') {
                        closeModal();
                    }
                    return;
                }

                // Kill connections
                if (e.key === 'k' || e.key === 'K') {
                    e.preventDefault();
                    killAllConnections();
                    return;
                }

                // Reset video
                if ((e.key === 'r' || e.key === 'R') && els.modal.style.display === 'block') {
                    const file = state.filteredFiles[state.currentIndex];
                    if (file?.type === 'video') {
                        e.preventDefault();
                        reloadCurrentVideo();
                    }
                    return;
                }

                // Modal navigation
                if (els.modal.style.display !== 'block') return;

                if (e.key === 'ArrowLeft') navigate(-1);
                else if (e.key === 'ArrowRight') navigate(1);
                else if (e.key === ' ' && state.filteredFiles[state.currentIndex]?.type !== 'video') {
                    e.preventDefault();
                    toggleSlideshow();
                }
            });

            // Touch swipe - only for non-video
            els.modalContent.addEventListener('touchstart', e => {
                const current = state.filteredFiles[state.currentIndex];
                if (current?.type === 'video') {
                    state.touchStartX = null;
                    return;
                }
                if (e.target.tagName === 'VIDEO' || e.target.closest('video')) {
                    state.touchStartX = null;
                    return;
                }
                state.touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            els.modalContent.addEventListener('touchend', e => {
                if (state.touchStartX === null) return;
                const current = state.filteredFiles[state.currentIndex];
                if (current?.type === 'video') return;
                if (e.target.tagName === 'VIDEO' || e.target.closest('video')) return;

                const diff = state.touchStartX - e.changedTouches[0].screenX;
                if (Math.abs(diff) > 50) navigate(diff > 0 ? 1 : -1);
            }, { passive: true });

            // Mouse movement for immersive
            els.modal.addEventListener('mousemove', resetImmersiveTimer);

            // Page visibility - pause video when hidden
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && els.modal.style.display === 'block') {
                    const video = els.modalContent.querySelector('video');
                    if (video) video.pause();
                }
            });

            // Before unload - cleanup
            window.addEventListener('beforeunload', () => {
                destroyVideo();
                preloadCache.clear();
            });

            // Online/offline
            window.addEventListener('online', () => {
                state.isOffline = false;
                els.offlineBanner.classList.remove('show');
                if (state.files.length === 0) fetchFiles(true).catch(console.error);
            });
            window.addEventListener('offline', () => {
                state.isOffline = true;
                els.offlineBanner.classList.add('show');
            });

            // Fullscreen change
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) els.modal.classList.remove('immersive');
            });
        }

        // ============ INITIALIZATION ============
        async function init() {
            initElements();
            initTheme();

            // Get share hash
            state.shareHash = new URLSearchParams(window.location.search).get('share') ||
                             window.location.pathname.split('/').filter(p => p && p !== 'gallery').pop();

            if (!state.shareHash || state.shareHash === 'gallery') {
                els.loading.style.display = 'none';
                els.errorTitle.textContent = 'Invalid share link';
                els.errorMessage.textContent = 'Please use a valid Droppr share link.';
                els.error.style.display = 'block';
                return;
            }

            // Load preferences
            const prefs = loadPrefs();
            state.filter = prefs.filter || 'all';
            state.sort = prefs.sort || 'type_asc';
            state.showDetails = prefs.show_details !== undefined ? !!prefs.show_details : true;
            const isSmallScreen = window.matchMedia?.('(max-width: 900px)')?.matches;
            state.layout = prefs.layout || ((IS_IOS || isSmallScreen) ? 'list' : 'grid');

            // Apply preferences
            els.sort.value = state.sort;
            els.filters.forEach(b => {
                const isActive = b.dataset.filter === state.filter;
                b.classList.toggle('active', isActive);
                b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            });
            if (state.layout === 'list') {
                els.grid.classList.add('list-view');
                document.getElementById('listViewBtn').classList.add('active');
                document.getElementById('gridViewBtn').classList.remove('active');
            }

            setDetailsEnabled(state.showDetails, { skipSave: true });

            // Setup handlers
            setupEventHandlers();

            // Set download all link
            els.downloadAll.href = `/api/share/${state.shareHash}/download`;

            // Check online status
            if (state.isOffline) {
                els.offlineBanner.classList.add('show');
            }

            // Fetch files
            try {
                await fetchFiles();
            } catch (err) {
                console.error(err);
                els.loading.style.display = 'none';
                els.errorTitle.textContent = 'Failed to load gallery';
                els.errorMessage.textContent = err.message || 'Please check your connection.';
                els.error.style.display = 'block';
            }
        }

        // Start
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>
