<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Media Gallery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-color: #6366f1;
            --accent-hover: #4f46e5;
            --success-color: #10b981;
            --modal-bg: rgba(0, 0, 0, 0.95);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 3rem 1.5rem 2rem;
            position: relative;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }
        
        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        /* Controls Bar */
        .controls-bar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 2rem;
            align-items: center;
            justify-content: space-between;
        }

        .search-box {
            position: relative;
            flex-grow: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border-radius: 10px;
            color: white;
            font-family: inherit;
            transition: all 0.2s;
        }

        .search-box input:focus {
            border-color: var(--accent-color);
            background: rgba(0, 0, 0, 0.3);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            background: rgba(0,0,0,0.2);
            padding: 0.25rem;
            border-radius: 10px;
        }

        .filter-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .filter-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .sort-select {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            cursor: pointer;
        }

        .action-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
        }

        .action-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Gallery Grid */
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem 3rem;
        }

        .media-grid {
            column-count: 4;
            column-gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .media-grid { column-count: 3; }
        }
        @media (max-width: 900px) {
            .media-grid { column-count: 2; }
            .controls-bar { flex-direction: column; align-items: stretch; }
            .header h1 { font-size: 2rem; }
        }
        @media (max-width: 600px) {
            .media-grid { column-count: 1; }
        }

        .media-card {
            break-inside: avoid;
            background: var(--card-bg);
            backdrop-filter: blur(5px);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .media-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .media-preview-container {
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .media-preview {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.5s ease;
        }

        .media-card:hover .media-preview {
            transform: scale(1.03);
        }

        .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        .media-info {
            padding: 1rem;
        }

        .media-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .media-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .card-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .card-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 0.5rem;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            text-decoration: none;
        }

        .card-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .card-btn.primary {
            background: var(--accent-color);
        }
        .card-btn.primary:hover {
            background: var(--accent-hover);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: var(--modal-bg);
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content-wrapper {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-media {
            max-width: 90%;
            max-height: 85vh;
            border-radius: 8px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            object-fit: contain;
            transition: transform 0.3s ease, max-height 0.3s ease, max-width 0.3s ease;
        }

        /* Immersive Mode */
        .modal.immersive {
            background: black;
            cursor: none; /* Hide cursor by default */
        }
        
        .modal.immersive.active-user {
            cursor: default;
        }

        .modal.immersive .modal-media {
            max-width: 100vw;
            max-height: 100vh;
            border-radius: 0;
        }

        .modal-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 10;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .modal-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2rem 1.5rem;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            text-align: center;
            z-index: 10;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        /* Hide controls in immersive mode unless active */
        .modal.immersive:not(.active-user) .modal-header {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }
        
        .modal.immersive:not(.active-user) .modal-footer {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .modal.immersive:not(.active-user) .nav-btn {
            opacity: 0;
            pointer-events: none;
        }

        .modal-controls {
            display: flex;
            gap: 1rem;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            padding: 1rem;
            cursor: pointer;
            z-index: 5;
            transition: opacity 0.5s ease;
            border-radius: 50%;
            margin: 0 1rem;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-prev { left: 0; }
        .nav-next { right: 0; }

        .file-placeholder {
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 4rem;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 2000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-icon {
            color: var(--success-color);
            font-size: 1.2rem;
        }

        /* SVG Icons helpers */
        .icon { width: 1em; height: 1em; fill: currentColor; }

        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
            color: var(--text-secondary);
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            background: var(--accent-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border: none;
            font-size: 1.5rem;
        }

        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            background: var(--accent-hover);
            transform: translateY(-5px);
        }

        /* Media Card Improvements */
        .media-tag {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: white;
            z-index: 2;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .media-preview-container::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent 60%, rgba(0,0,0,0.4));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .media-card:hover .media-preview-container::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Shared Media Gallery</h1>
        <p>Viewing files shared via Droppr</p>
        
        <div class="controls-bar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Search files...">
            </div>
            
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="image">Images</button>
                <button class="filter-btn" data-filter="video">Videos</button>
            </div>

            <select class="sort-select" id="sortSelect">
                <option value="type_asc">Type (Images first)</option>
                <option value="type_desc">Type (Videos first)</option>
                <option value="name_asc">Name (A-Z)</option>
                <option value="name_desc">Name (Z-A)</option>
                <option value="size_desc">Size (Largest)</option>
                <option value="size_asc">Size (Smallest)</option>
            </select>

            <button class="action-btn secondary" id="copyLinkBtn">
                üîó Share
            </button>
            
            <a href="#" id="downloadAllBtn" class="action-btn">
                ‚¨áÔ∏è Download All
            </a>
        </div>
    </div>
    
    <div class="gallery-container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading gallery...</p>
        </div>
        
        <div id="galleryGrid" class="media-grid"></div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>No files found</h3>
            <p>Try adjusting your search or filters</p>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-header">
            <div class="modal-controls">
                <button class="icon-btn" id="zoomBtn" title="Zoom">üîç</button>
                <button class="icon-btn" id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
                <button class="icon-btn" id="slideshowBtn" title="Slideshow">‚ñ∂</button>
                <a href="#" class="icon-btn" id="viewOriginalBtn" target="_blank" title="View Original">‚Üó</a>
            </div>
            <button class="icon-btn" id="closeBtn" title="Close">√ó</button>
        </div>
        
        <button class="nav-btn nav-prev" id="prevBtn">‚ùÆ</button>
        <button class="nav-btn nav-next" id="nextBtn">‚ùØ</button>
        
        <div class="modal-content-wrapper" id="modalContent">
            <!-- Media injected here -->
        </div>
        
        <div class="modal-footer">
            <h3 id="modalTitle">Filename</h3>
            <p id="modalMeta">Meta info</p>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <span class="toast-icon">‚úì</span>
        <span id="toastMessage">Action successful</span>
    </div>

    <button id="backToTop" class="back-to-top" title="Back to Top">‚Üë</button>

    <script>
        // State
        const state = {
            files: [],
            filteredFiles: [],
            currentIndex: 0,
            // Robust extraction: remove empty segments and 'gallery', take the last one
            shareHash: new URLSearchParams(window.location.search).get('share') || 
                       window.location.pathname.split('/').filter(p => p && p !== 'gallery').pop(),
            filter: 'all',
            sort: 'type_asc', // Default sort by type
            search: '',
            isSlideshow: false,
            slideshowInterval: null,
            isZoomed: false,
            immersiveTimer: null,
            touchStartX: 0,
            touchEndX: 0
        };

        // DOM Elements
        const els = {
            grid: document.getElementById('galleryGrid'),
            loading: document.getElementById('loading'),
            empty: document.getElementById('emptyState'),
            search: document.getElementById('searchInput'),
            sort: document.getElementById('sortSelect'),
            filters: document.querySelectorAll('.filter-btn'),
            modal: document.getElementById('modal'),
            modalContent: document.getElementById('modalContent'),
            modalTitle: document.getElementById('modalTitle'),
            modalMeta: document.getElementById('modalMeta'),
            downloadAll: document.getElementById('downloadAllBtn'),
            copyLink: document.getElementById('copyLinkBtn'),
            backToTop: document.getElementById('backToTop'),
            viewOriginal: document.getElementById('viewOriginalBtn')
        };

        // Initialize
        async function init() {
            if (!state.shareHash || state.shareHash === 'gallery') {
                showToast('Invalid share link', 'error');
                return;
            }

            // Scroll listener for Back to Top
            window.addEventListener('scroll', () => {
                if (window.scrollY > 500) {
                    els.backToTop.classList.add('show');
                } else {
                    els.backToTop.classList.remove('show');
                }
            });

            els.backToTop.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Setup download link
            els.downloadAll.href = `/api/share/${state.shareHash}/download`;

            // Load data
            try {
                const res = await fetch(`/api/share/${state.shareHash}/files`);
                if (!res.ok) throw new Error('Failed to load files');
                state.files = await res.json();
                filterAndRender();
            } catch (err) {
                console.error(err);
                els.loading.innerHTML = `<p style="color: #ef4444">Failed to load gallery. Please try again.</p>`;
            }
        }

        // Filtering & Sorting
        function filterAndRender() {
            els.loading.style.display = 'none';
            
            // Filter
            state.filteredFiles = state.files.filter(file => {
                const matchesType = state.filter === 'all' || file.type === state.filter;
                const matchesSearch = file.name.toLowerCase().includes(state.search.toLowerCase());
                return matchesType && matchesSearch;
            });

            // Sort
            state.filteredFiles.sort((a, b) => {
                switch(state.sort) {
                    case 'type_asc': 
                        // Images first, then videos, then others
                        const typeScore = (t) => t === 'image' ? 1 : (t === 'video' ? 2 : 3);
                        const typeDiff = typeScore(a.type) - typeScore(b.type);
                        return typeDiff !== 0 ? typeDiff : a.name.localeCompare(b.name);
                    case 'type_desc': 
                        // Videos first, then images, then others
                        const typeScoreDesc = (t) => t === 'video' ? 1 : (t === 'image' ? 2 : 3);
                        const typeDiffDesc = typeScoreDesc(a.type) - typeScoreDesc(b.type);
                        return typeDiffDesc !== 0 ? typeDiffDesc : a.name.localeCompare(b.name);
                    case 'name_asc': return a.name.localeCompare(b.name);
                    case 'name_desc': return b.name.localeCompare(a.name);
                    case 'size_asc': return a.size - b.size;
                    case 'size_desc': return b.size - a.size;
                    default: return 0;
                }
            });

            renderGrid();
        }

        function renderGrid() {
            els.grid.innerHTML = '';
            
            if (state.filteredFiles.length === 0) {
                els.empty.style.display = 'block';
                return;
            }
            
            els.empty.style.display = 'none';
            
            state.filteredFiles.forEach((file, index) => {
                const card = document.createElement('div');
                card.className = 'media-card';
                card.innerHTML = createCardHTML(file, index);
                els.grid.appendChild(card);
            });
        }

        function createCardHTML(file, index) {
        function createCardHTML(file, index) {
            // Use file.path if available (new backend), fall back to file.name
            const path = file.path || file.name;
            const fileUrl = `/api/share/${state.shareHash}/file/${encodeURIComponent(path)}`;
            const isVideo = file.type === 'video';
            const isVideo = file.type === 'video';
            const isImage = file.type === 'image';
            
            let preview = '';
            if (isImage) {
                preview = `<img class="media-preview" src="${fileUrl}" loading="lazy" alt="${file.name}" onerror="this.parentElement.innerHTML='<div class=\'file-placeholder\'>‚ö†Ô∏è Image Error</div>'">`;
            } else if (isVideo) {
                preview = `
                    <div class="media-preview-container">
                        <div class="file-placeholder" style="background: #000;">
                            <video src="${fileUrl}#t=0.1" preload="metadata" style="width:100%; height:100%; object-fit:cover;"></video>
                        </div>
                        <div class="play-icon">‚ñ∂</div>
                    </div>
                `;
            } else {
                preview = `
                    <div class="file-placeholder">
                        <div style="font-size: 3rem; margin-bottom: 1rem">üìÑ</div>
                        <div>${file.extension.toUpperCase()}</div>
                    </div>
                `;
            }

            const tag = isVideo ? '<div class="media-tag">Video</div>' : (isImage ? '<div class="media-tag">Image</div>' : '');

            return `
                <div class="media-preview-container" onclick="openModal(${index})">
                    ${tag}
                    ${preview}
                </div>
                <div class="media-info">
                    <div class="media-title" title="${file.name}">${file.name}</div>
                    <div class="media-meta">
                        <span>${file.extension.toUpperCase()}</span>
                        <span>${formatSize(file.size)}</span>
                    </div>
                    <div class="card-actions">
                        <button class="card-btn primary" onclick="openModal(${index})">
                            ${isVideo ? 'Play' : 'View'}
                        </button>
                        <a href="${fileUrl}" download="${file.name}" class="card-btn">
                            Download
                        </a>
                    </div>
                </div>
            `;
        }

        // Modal Functions
        window.openModal = function(index) {
            state.currentIndex = index;
            els.modal.style.display = 'block';
            // Force reflow for transition
            els.modal.offsetHeight;
            els.modal.classList.add('show');
            updateModalContent();
            resetImmersiveTimer();
            
            // Add swipe listeners when modal opens
            els.modal.addEventListener('touchstart', handleTouchStart, {passive: true});
            els.modal.addEventListener('touchend', handleTouchEnd, {passive: true});
        };

        function updateModalContent() {
            const file = state.filteredFiles[state.currentIndex];
            const path = file.path || file.name;
            const fileUrl = `/api/share/${state.shareHash}/file/${encodeURIComponent(path)}`;
            
            els.modalTitle.textContent = file.name;
            els.modalMeta.textContent = `${state.currentIndex + 1} of ${state.filteredFiles.length} ‚Ä¢ ${formatSize(file.size)}`;
            
            // Update View Original Link
            els.viewOriginal.href = fileUrl;

            els.modalContent.innerHTML = '';
            
            if (file.type === 'video') {
                els.modalContent.innerHTML = `
                    <video class="modal-media" controls autoplay playsinline>
                        <source src="${fileUrl}" type="video/${file.extension === 'mov' ? 'quicktime' : 'mp4'}">
                        Your browser does not support video.
                    </video>
                `;
            } else if (file.type === 'image') {
                els.modalContent.innerHTML = `
                    <img class="modal-media" src="${fileUrl}" alt="${file.name}">
                `;
            } else {
                els.modalContent.innerHTML = `
                    <div style="text-align: center; color: white;">
                        <div style="font-size: 5rem; margin-bottom: 2rem">üìÑ</div>
                        <p>Preview not available for this file type.</p>
                        <a href="${fileUrl}" class="action-btn" style="margin-top: 1rem; display: inline-block;">Download File</a>
                    </div>
                `;
            }

            // Update nav buttons
            document.getElementById('prevBtn').style.display = state.currentIndex > 0 ? 'block' : 'none';
            document.getElementById('nextBtn').style.display = state.currentIndex < state.filteredFiles.length - 1 ? 'block' : 'none';
        }

        function closeModal() {
            els.modal.classList.remove('show');
            exitFullscreen(); // Ensure we exit browser fullscreen too
            
            // Remove swipe listeners
            els.modal.removeEventListener('touchstart', handleTouchStart);
            els.modal.removeEventListener('touchend', handleTouchEnd);

            setTimeout(() => {
                els.modal.style.display = 'none';
                els.modalContent.innerHTML = ''; // Stop video playback
                stopSlideshow();
                state.isZoomed = false;
                els.modal.classList.remove('immersive'); // Reset immersive state
            }, 300);
        }

        function handleTouchStart(e) {
            state.touchStartX = e.changedTouches[0].screenX;
        }

        function handleTouchEnd(e) {
            state.touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }

        function handleSwipe() {
            const threshold = 50;
            if (state.touchEndX < state.touchStartX - threshold) {
                navigate(1); // Swipe left, go next
            }
            if (state.touchEndX > state.touchStartX + threshold) {
                navigate(-1); // Swipe right, go prev
            }
        }

        function navigate(dir) {
            const newIndex = state.currentIndex + dir;
            if (newIndex >= 0 && newIndex < state.filteredFiles.length) {
                state.currentIndex = newIndex;
                updateModalContent();
                resetImmersiveTimer();
            }
        }

        // Utilities
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function toggleSlideshow() {
            if (state.isSlideshow) {
                stopSlideshow();
            } else {
                startSlideshow();
            }
        }

        function startSlideshow() {
            state.isSlideshow = true;
            document.getElementById('slideshowBtn').innerHTML = '‚è∏';
            showToast('Slideshow started');
            state.slideshowInterval = setInterval(() => {
                if (state.currentIndex < state.filteredFiles.length - 1) {
                    navigate(1);
                } else {
                    state.currentIndex = 0;
                    updateModalContent();
                }
            }, 3000);
            
            // Enter fullscreen automatically for slideshow
            if (!document.fullscreenElement) {
                toggleBrowserFullscreen();
            }
        }

        function stopSlideshow() {
            state.isSlideshow = false;
            document.getElementById('slideshowBtn').innerHTML = '‚ñ∂';
            if (state.slideshowInterval) clearInterval(state.slideshowInterval);
        }

        // Fullscreen & Immersive Mode Logic
        function toggleBrowserFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            } else {
                document.exitFullscreen();
            }
        }

        function exitFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        // Monitor fullscreen change to toggle immersive mode class
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                els.modal.classList.add('immersive');
                resetImmersiveTimer();
            } else {
                els.modal.classList.remove('immersive');
                els.modal.classList.remove('active-user');
                clearTimeout(state.immersiveTimer);
            }
        });

        // Immersive UI timer
        function resetImmersiveTimer() {
            if (!document.fullscreenElement) return;
            
            els.modal.classList.add('active-user');
            clearTimeout(state.immersiveTimer);
            
            state.immersiveTimer = setTimeout(() => {
                // Only hide if not hovering over controls directly (optional enhancement, simple timer for now)
                els.modal.classList.remove('active-user');
            }, 3000); // Hide after 3 seconds of inactivity
        }

        // Event Listeners
        els.search.addEventListener('input', (e) => {
            state.search = e.target.value;
            filterAndRender();
        });

        els.sort.addEventListener('change', (e) => {
            state.sort = e.target.value;
            filterAndRender();
        });

        els.filters.forEach(btn => {
            btn.addEventListener('click', () => {
                els.filters.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.filter = btn.dataset.filter;
                filterAndRender();
            });
        });

        els.copyLink.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href);
            showToast('Link copied to clipboard');
        });

        document.getElementById('closeBtn').addEventListener('click', closeModal);
        document.getElementById('prevBtn').addEventListener('click', () => navigate(-1));
        document.getElementById('nextBtn').addEventListener('click', () => navigate(1));
        
        document.getElementById('fullscreenBtn').addEventListener('click', toggleBrowserFullscreen);
        document.getElementById('slideshowBtn').addEventListener('click', toggleSlideshow);

        document.getElementById('zoomBtn').addEventListener('click', () => {
            const img = els.modalContent.querySelector('img');
            if (!img) return;
            state.isZoomed = !state.isZoomed;
            img.style.transform = state.isZoomed ? 'scale(2)' : 'scale(1)';
            img.style.cursor = state.isZoomed ? 'zoom-out' : 'zoom-in';
        });

        // Mouse movement in modal resets immersive timer
        els.modal.addEventListener('mousemove', resetImmersiveTimer);
        els.modal.addEventListener('click', (e) => {
            if(e.target === els.modal || e.target.classList.contains('modal-content-wrapper')) {
                 // Toggle controls visibility on click/tap
                 if (document.fullscreenElement) {
                     els.modal.classList.toggle('active-user');
                     if (els.modal.classList.contains('active-user')) {
                         resetImmersiveTimer();
                     } else {
                         clearTimeout(state.immersiveTimer);
                     }
                 }
            }
        });

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (els.modal.style.display === 'block') {
                if (e.key === 'Escape') closeModal(); // Browser handles fullscreen exit on ESC usually, but this closes modal
                if (e.key === 'ArrowLeft') navigate(-1);
                if (e.key === 'ArrowRight') navigate(1);
                if (e.key === ' ') {
                    e.preventDefault();
                    toggleSlideshow();
                }
                
                resetImmersiveTimer();
            }
        });

        init();
    </script>
</body>
</html>