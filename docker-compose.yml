services:
  app:
    build:
      context: ./app
    image: mri-cooling-droppr-app:custom
    container_name: droppr-app
    restart: unless-stopped
    user: "1000:1000"
    volumes:
      - ./data:/srv
      - ./database:/database
      - ./config:/config
    networks:
      - default

  droppr:
    image: nginx:1.25-alpine
    container_name: droppr
    restart: unless-stopped
    ports:
      - "${DROPPR_HOST_PORT:-8098}:80"
    volumes:
      - ./nginx-fixed/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/gallery.html:/usr/share/nginx/html/gallery.html:ro
      - ./nginx/analytics.html:/usr/share/nginx/html/analytics.html:ro
      - ./nginx/media-viewer.html:/usr/share/nginx/html/media-viewer.html:ro
      - ./nginx-fixed/video-player.html:/usr/share/nginx/html/video-player.html:ro
      - ./nginx/test-media.html:/usr/share/nginx/html/test-media.html:ro
      - ./nginx/stream-gallery.html:/usr/share/nginx/html/stream-gallery.html:ro
      - ./nginx/droppr-theme.css:/usr/share/nginx/html/droppr-theme.css:ro
      - ./nginx-fixed/droppr-panel.js:/usr/share/nginx/html/droppr-panel.js:ro
      - ./database/proxy-cache:/usr/share/nginx/html/proxy-cache:ro
    depends_on:
      - app
    networks:
      - default

  faststart:
    build:
      context: ./faststart
    container_name: droppr-faststart
    restart: unless-stopped
    user: "1000:1000"
    volumes:
      - ./data:/srv
      - ./database:/database
    environment:
      - WATCH_DIR=/srv
      # Video re-encode settings (HEVCâ†’H.264 and rare error-fix fallbacks).
      # Lower CRF = higher quality (and larger files).
      - DROPPR_FASTSTART_X264_PRESET=${DROPPR_FASTSTART_X264_PRESET:-slow}
      - DROPPR_FASTSTART_X264_CRF=${DROPPR_FASTSTART_X264_CRF:-16}
      - DROPPR_FASTSTART_AAC_BITRATE=${DROPPR_FASTSTART_AAC_BITRATE:-256k}
      - DROPPR_FASTSTART_COPY_AUDIO=${DROPPR_FASTSTART_COPY_AUDIO:-true}
      - DROPPR_FASTSTART_FFMPEG_TIMEOUT_SECONDS=${DROPPR_FASTSTART_FFMPEG_TIMEOUT_SECONDS:-7200}
    depends_on:
      - app

  media-server:
    build:
      context: ./media-server
    container_name: droppr-media-server
    restart: unless-stopped
    command: gunicorn --bind 0.0.0.0:5000 --workers 4 --threads 10 --access-logfile - --error-logfile - app:app
    user: "1000:1000"
    volumes:
      - ./database:/database
    environment:
      - DROPPR_CACHE_DIR=/database/thumb-cache
      - DROPPR_THUMB_MAX_CONCURRENCY=1
      - DROPPR_PROXY_CACHE_DIR=/database/proxy-cache
      - DROPPR_PROXY_MAX_CONCURRENCY=1
    depends_on:
      - app
    networks:
      - default

  cloudflared-droppr:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-droppr
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflare/config.yml:/etc/cloudflared/config.yml:ro
      - ./cloudflare/creds:/etc/cloudflared/creds:ro
    depends_on:
      - droppr
    profiles:
      - tunnel
    networks:
      - default

networks:
  default:
    name: mri-cooling-droppr_default
